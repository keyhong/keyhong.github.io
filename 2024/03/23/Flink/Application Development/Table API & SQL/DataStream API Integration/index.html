<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="[Flink] Table API &amp; SQL - DataStream API Integration, Data Engineering,Data Analysis,Python Backend">
    <meta name="description" content="DataStream API IntegrationBoth Table API and DataStream API are equally important when it comes to defining a data proce">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>[Flink] Table API &amp; SQL - DataStream API Integration | Keyhong</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.0.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span diy-happy-monkey">Keyhong</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li>
    <!-- <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a> -->
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Keyhong</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/images/logos/flink-logo.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title diy-neon-red">
                        [Flink] Table API &amp; SQL - DataStream API Integration</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                        <div class="article-tag">
                            <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                                <span class="chip bg-color">
                                    2024-03-23</span>
                        </div>
                    
                    


                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Flink/" class="post-category">
                                Flink
                            </a>
                        
                    </div>
                    
                </div>
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="DataStream-API-Integration"><a href="#DataStream-API-Integration" class="headerlink" title="DataStream API Integration"></a>DataStream API Integration</h1><p>Both Table API and DataStream API are equally important when it comes to defining a data processing pipeline.</p>
<p>The DataStream API offers the primitives of stream processing (namely time, state, and dataflow management) in a relatively low-level imperative programming API. The Table API abstracts away many internals and provides a structured and declarative API.</p>
<p>Both APIs can work with bounded and unbounded streams.</p>
<p>Bounded streams need to be managed when processing historical data. Unbounded streams occur in real-time processing scenarios that might be initialized with historical data first.</p>
<p>For efficient execution, both APIs offer processing bounded streams in an optimized batch execution mode. However, since batch is just a special case of streaming, it is also possible to run pipelines of bounded streams in regular streaming execution mode.</p>
<p>Pipelines in one API can be defined end-to-end without dependencies on the other API. However, it might be useful to mix both APIs for various reasons:</p>
<ul>
<li>Use the table ecosystem for accessing catalogs or connecting to external systems easily, before implementing the main pipeline in DataStream API.</li>
<li>Access some of the SQL functions for stateless data normalization and cleansing, before implementing the main pipeline in DataStream API.</li>
<li>Switch to DataStream API every now and then if a more low-level operation (e.g. custom timer handling) is not present in Table API.</li>
</ul>
<p>Flink provides special bridging functionalities to make the integration with DataStream API as smooth as possible.</p>
<blockquote>
<p>Switching between DataStream and Table API adds some conversion overhead. For example, internal data structures of the table runtime (i.e. <code>RowData</code>) that partially work on binary data need to be converted to more user-friendly data structures (i.e. <code>Row</code>). Usually, this overhead can be neglected but is mentioned here for completeness.</p>
</blockquote>
<p>데이터 처리 파이프라인을 정의할 때 Table API와 DataStream API는 모두 중요합니다.</p>
<p>DataStream API는 상대적으로 저수준 명령형 프로그래밍 API에서 스트림 처리의 기본 기능 (시간, 상태 및 데이터 플로우 관리)를 제공합니다. Table API는 많은 내부 기능을 추상화하고 구조화되고 선언적인 API를 제공합니다.</p>
<p>두 API 모두 유한 및 무제한 스트림과 작업할 수 있습니다.</p>
<p>유한 스트림은 과거 데이터를 처리할 때 관리해야 합니다. 무제한 스트림은 실시간 처리 시나리오에서 발생하며, 먼저 과거 데이터로 초기화될 수 있습니다.</p>
<p>효율적인 실행을 위해 두 API 모두 최적화된 배치 실행 모드에서 유한 스트림을 처리할 수 있습니다. 그러나 배치는 스트리밍의 특수한 경우일 뿐이므로 유한 스트림의 파이프라인을 일반적인 스트리밍 실행 모드에서 실행하는 것도 가능합니다.</p>
<p>한 API의 파이프라인은 다른 API에 대한 종속성 없이 end-to-end로 정의될 수 있습니다. 그러나 다양한 이유로 두 API를 혼합하는 것이 유용할 수 있습니다:</p>
<ul>
<li>주요 파이프라인을 DataStream API로 구현하기 전에 카탈로그에 액세스하거나 외부 시스템에 연결하는 데 테이블 생태계를 사용하세요.</li>
<li>주요 파이프라인을 DataStream API로 구현하기 전에 상태 없는 데이터 정규화 및 정제를 위해 일부 SQL 함수에 액세스하세요.</li>
<li>Table API에 없는 더 낮은 수준의 작업(예: 사용자 지정 타이머 처리)이 필요한 경우 DataStream API로 전환하세요.</li>
</ul>
<p>Flink는 DataStream API와의 통합을 가능한 한 원활하게 만들기 위해 특별한 연결 기능을 제공합니다.</p>
<blockquote>
<p>DataStream와 Table API 간 전환은 일부 변환 오버헤드를 추가합니다. 예를 들어, 이전에 바이너리 데이터에서 부분적으로 작동하는 테이블 런타임의 내부 데이터 구조 (즉, <code>RowData</code>)를 더 사용자 친화적인 데이터 구조 (즉, <code>Row</code>)로 변환해야 합니다. 일반적으로 이 오버헤드는 무시할 수 있지만 완전성을 위해 여기에 언급됩니다.</p>
</blockquote>
<h2 id="Converting-between-DataStream-and-Table"><a href="#Converting-between-DataStream-and-Table" class="headerlink" title="Converting between DataStream and Table"></a>Converting between DataStream and Table</h2><p>Flink provides a specialized <code>StreamTableEnvironment</code> for integrating with the DataStream API. Those environments extend the regular <code>TableEnvironment</code> with additional methods and take the <code>StreamExecutionEnvironment</code> used in the DataStream API as a parameter.</p>
<p>The following code shows an example of how to go back and forth between the two APIs. Column names and types of the <code>Table</code> are automatically derived from the <code>TypeInformation</code> of the DataStream. Since the DataStream API does not support changelog processing natively, the code assumes append-only&#x2F;insert-only semantics during the stream-to-table and table-to-stream conversion.</p>
<p>Flink은 DataStream API와 통합하기 위한 전용 <code>StreamTableEnvironment</code>를 제공합니다. 이러한 환경은 일반적인 <code>TableEnvironment</code>를 추가 메서드로 확장하며, DataStream API에서 사용하는 <code>StreamExecutionEnvironment</code>를 매개변수로 사용합니다.</p>
<p>다음 코드는 두 API 간에 이동하는 예제를 보여줍니다. <code>Table</code>의 열 이름 및 유형은 DataStream의 <code>TypeInformation</code>에서 자동으로 파생됩니다. DataStream API에서 변경 로그 처리를 기본적으로 지원하지 않으므로, 이 코드는 스트림에서 테이블로 및 테이블에서 스트림으로의 변환 중에 append-only&#x2F;insert-only 의미론을 가정합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span></span><span class="token punctuation">;</span>

<span class="token comment">// create environments of both APIs</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create a DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the insert-only DataStream as a Table</span>
<span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// register the Table object as a view and query it</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> inputTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT UPPER(f0) FROM InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the insert-only Table as a DataStream again</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> resultStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a printing sink and execute in DataStream API</span>
resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +I[ALICE]</span>
<span class="token comment">// +I[BOB]</span>
<span class="token comment">// +I[JOHN]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> StreamTableEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo <span class="token keyword">import</span> Types

env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
t_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

<span class="token comment"># create a DataStream</span>
ds <span class="token operator">=</span> env<span class="token punctuation">.</span>from_collection<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># interpret the insert-only DataStream as a Table</span>
t <span class="token operator">=</span> t_env<span class="token punctuation">.</span>from_data_stream<span class="token punctuation">(</span>ds<span class="token punctuation">)</span>

<span class="token comment"># register the Table object as a view and query it</span>
t_env<span class="token punctuation">.</span>create_temporary_view<span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
res_table <span class="token operator">=</span> t_env<span class="token punctuation">.</span>sql_query<span class="token punctuation">(</span><span class="token string">"SELECT UPPER(f0) FROM InputTable"</span><span class="token punctuation">)</span>

<span class="token comment"># interpret the insert-only Table as a DataStream again</span>
res_ds <span class="token operator">=</span> t_env<span class="token punctuation">.</span>to_data_stream<span class="token punctuation">(</span>res_table<span class="token punctuation">)</span>

<span class="token comment"># add a printing sink and execute in DataStream API</span>
res_ds<span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># prints:</span>
<span class="token comment"># +I[ALICE]</span>
<span class="token comment"># +I[BOB]</span>
<span class="token comment"># +I[JOHN]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>The complete semantics of <code>fromDataStream</code> and <code>toDataStream</code> can be found in the <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/data_stream_api/#handling-of-insert-only-streams">dedicated section below</a>. In particular, the section discusses how to influence the schema derivation with more complex and nested types. It also covers working with event-time and watermarks.</p>
<p>Depending on the kind of query, in many cases the resulting dynamic table is a pipeline that does not only produce insert-only changes when converting the Table to a <code>DataStream</code> but also produces retractions and other kinds of updates. During table-to-stream conversion, this could lead to an exception similar to</p>
<p><code>fromDataStream</code> 및 <code>toDataStream</code>의 전체 의미론은 아래 전용 섹션에서 찾을 수 있습니다. 특히, 이 섹션에서는 더 복잡하고 중첩된 유형을 사용하여 스키마 파생에 영향을 미치는 방법에 대해 논의합니다. 또한 이벤트 시간 및 워터마크 처리에 대해서도 다룹니다.</p>
<p>쿼리의 종류에 따라 많은 경우 결과 동적 테이블은 단순히 테이블을 DataStream으로 변환할 때 삽입 전용 변경 사항만 생성하는 파이프라인입니다. 그러나 테이블을 스트림으로 변환하는 중에는 리트랙션(retractions) 및 기타 종류의 업데이트도 발생할 수 있습니다. 테이블에서 스트림으로 변환하는 과정에서 이는 유사한 예외를 발생시킬 수 있습니다.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Table sink <span class="token string">'Unregistered_DataStream_Sink_1'</span> doesn't support consuming update changes <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>in which case one needs to revise the query again or switch to toChangelogStream.</p>
<p>The following example shows how updating tables can be converted. Every result row represents an entry in a changelog with a change flag that can be queried by calling <code>row.getKind()</code> on it. In the example, the second score for Alice creates an <em>update before</em> (-U) and <em>update after</em> (+U) change.</p>
<p>그러한 경우에는 쿼리를 다시 검토하거나 <code>toChangelogStream</code>으로 전환해야 할 수 있습니다.</p>
<p>다음 예제는 업데이트된 테이블을 어떻게 변환하는지 보여줍니다. 각 결과 행은 변경 로그(changelog) 항목을 나타내며, 해당 항목에서 <code>row.getKind()</code>를 호출하여 조회할 수 있는 변경 플래그가 있습니다. 예제에서는 Alice의 두 번째 점수가 변경 전(-U)과 변경 후(+U)를 나타내는 업데이트를 생성합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span></span><span class="token punctuation">;</span>

<span class="token comment">// create environments of both APIs</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create a DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
    <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the insert-only DataStream as a Table</span>
<span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// register the Table object as a view and query it</span>
<span class="token comment">// the query contains an aggregation that produces updates</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> inputTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
    <span class="token string">"SELECT name, SUM(score) FROM InputTable GROUP BY name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the updating Table as a changelog DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> resultStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toChangelogStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a printing sink and execute in DataStream API</span>
resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +I[Alice, 12]</span>
<span class="token comment">// +I[Bob, 10]</span>
<span class="token comment">// -U[Alice, 12]</span>
<span class="token comment">// +U[Alice, 112]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> StreamTableEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo <span class="token keyword">import</span> Types

<span class="token comment"># create environments of both APIs</span>
env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
t_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

<span class="token comment"># create a DataStream</span>
ds <span class="token operator">=</span> env<span class="token punctuation">.</span>from_collection<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          type_info<span class="token operator">=</span>Types<span class="token punctuation">.</span>ROW_NAMED<span class="token punctuation">(</span>
                          <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                          <span class="token punctuation">[</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

input_table <span class="token operator">=</span> t_env<span class="token punctuation">.</span>from_data_stream<span class="token punctuation">(</span>ds<span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span>

<span class="token comment"># register the Table object as a view and query it</span>
<span class="token comment"># the query contains an aggregation that produces updates</span>
t_env<span class="token punctuation">.</span>create_temporary_view<span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> input_table<span class="token punctuation">)</span>
res_table <span class="token operator">=</span> t_env<span class="token punctuation">.</span>sql_query<span class="token punctuation">(</span><span class="token string">"SELECT name, SUM(score) FROM InputTable GROUP BY name"</span><span class="token punctuation">)</span>

<span class="token comment"># interpret the updating Table as a changelog DataStream</span>
res_stream <span class="token operator">=</span> t_env<span class="token punctuation">.</span>to_changelog_stream<span class="token punctuation">(</span>res_table<span class="token punctuation">)</span>

<span class="token comment"># add a printing sink and execute in DataStream API</span>
res_stream<span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># prints:</span>
<span class="token comment"># +I[Alice, 12]</span>
<span class="token comment"># +I[Bob, 10]</span>
<span class="token comment"># -U[Alice, 12]</span>
<span class="token comment"># +U[Alice, 112]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The complete semantics of <code>fromChangelogStream</code> and <code>toChangelogStream</code> can be found in the <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/data_stream_api/#handling-of-insert-only-streams">dedicated section below</a>. In particular, the section discusses how to influence the schema derivation with more complex and nested types. It covers working with event-time and watermarks. It discusses how to declare a primary key and changelog mode for the input and output streams.</p>
<p>The example above shows how the final result is computed incrementally by continuously emitting <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/concepts/dynamic_tables/">row-wise updates</a> for each incoming record. However, in cases where the input streams are finite (i.e. <em>bounded</em>), a result can be computed more efficiently by leveraging batch processing principles.</p>
<p>In batch processing, operators can be executed in successive stages that consume the entire input table before emitting results. For example, a join operator can sort both bounded inputs before performing the actual joining (i.e. <em>sort-merge join algorithm</em>), or build a hash table from one input before consuming the other (i.e. build&#x2F;probe phase of the <em>hash join algorithm</em>).</p>
<p>Both DataStream API and Table API offer a specialized <em>batch runtime mode</em>.</p>
<p>The following example illustrates that the unified pipeline is able to process both batch and streaming data by just switching a flag.</p>
<p><code>fromChangelogStream</code> 및 <code>toChangelogStream</code>의 전체 의미론은 <code>아래 전용 섹션</code>에서 찾을 수 있습니다. 특히, 이 섹션에서는 더 복잡하고 중첩된 유형을 사용하여 스키마 파생에 영향을 미치는 방법에 대해 논의합니다. 또한 이벤트 시간 및 워터마크 처리에 대해서도 다룹니다. 또한 입력 및 출력 스트림에 대한 기본 키 및 변경 로그 모드를 선언하는 방법에 대해서도 논의합니다.</p>
<p>위의 예제는 최종 결과가 연속적으로 수신되는 각 레코드에 대해 행 단위 업데이트를 지속적으로 발생시킴으로써 점진적으로 계산되는 방법을 보여줍니다. 그러나 입력 스트림이 유한한 경우(즉, 유한한 스트림인 경우), 일괄 처리(batch processing) 원칙을 활용하여 결과를 효율적으로 계산할 수 있습니다.</p>
<p>일괄 처리에서 연산자는 결과를 발생시키기 전에 전체 입력 테이블을 사용하는 연속적인 단계에서 실행될 수 있습니다. 예를 들어, 조인 연산자는 실제 조인을 수행하기 전에 두 개의 유한한 입력을 정렬할 수 있습니다(즉, 정렬-병합 조인 알고리즘), 또는 하나의 입력에서 해시 테이블을 빌드하여 다른 입력을 사용하기 전에 해시 조인 알고리즘의 빌드&#x2F;탐색 단계를 수행할 수 있습니다.</p>
<p>DataStream API 및 Table API 모두 전용 일괄 처리(runtime mode) 모드를 제공합니다.</p>
<p>다음 예제는 단순히 플래그를 전환함으로써 통합 파이프라인이 배치 및 스트리밍 데이터를 모두 처리할 수 있는지를 보여줍니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RuntimeExecutionMode</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span></span><span class="token punctuation">;</span>

<span class="token comment">// setup DataStream API</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set the batch runtime mode</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span><span class="token constant">BATCH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// uncomment this for streaming mode</span>
<span class="token comment">// env.setRuntimeMode(RuntimeExecutionMode.STREAMING);</span>

<span class="token comment">// setup Table API</span>
<span class="token comment">// the table environment adopts the runtime mode during initialization</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// define the same pipeline as above</span>

<span class="token comment">// prints in BATCH mode:</span>
<span class="token comment">// +I[Bob, 10]</span>
<span class="token comment">// +I[Alice, 112]</span>

<span class="token comment">// prints in STREAMING mode:</span>
<span class="token comment">// +I[Alice, 12]</span>
<span class="token comment">// +I[Bob, 10]</span>
<span class="token comment">// -U[Alice, 12]</span>
<span class="token comment">// +U[Alice, 112]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment<span class="token punctuation">,</span> RuntimeExecutionMode
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> StreamTableEnvironment

<span class="token comment"># setup DataStream API</span>
env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># set the batch runtime mode</span>
env<span class="token punctuation">.</span>set_runtime_mode<span class="token punctuation">(</span>RuntimeExecutionMode<span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span>

<span class="token comment"># uncomment this for streaming mode</span>
<span class="token comment"># env.set_runtime_mode(RuntimeExecutionMode.STREAMING)</span>

<span class="token comment"># setup Table API</span>
<span class="token comment"># the table environment adopts the runtime mode during initialization</span>
table_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

<span class="token comment"># define the same pipeline as above</span>
<span class="token comment"># prints in BATCH mode:</span>
<span class="token comment"># +I[Bob, 10]</span>
<span class="token comment"># +I[Alice, 112]</span>

<span class="token comment"># prints in STREAMING mode:</span>
<span class="token comment"># +I[Alice, 12]</span>
<span class="token comment"># +I[Bob, 10]</span>
<span class="token comment"># -U[Alice, 12]</span>
<span class="token comment"># +U[Alice, 112]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Once the changelog is applied to an external system (e.g. a key-value store), one can see that both modes are able to produce exactly the same output table. By consuming all input data before emitting results, the changelog of the batch mode consists solely of insert-only changes. See also the <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/data_stream_api/#batch-runtime-mode">dedicated batch mode section below</a> for more insights.</p>
<p>변경 로그가 외부 시스템(예: 키-값 저장소)에 적용된 후, 두 모드가 정확히 동일한 출력 테이블을 생성할 수 있음을 확인할 수 있습니다. 결과를 발생시키기 전에 모든 입력 데이터를 사용함으로써, 일괄 처리 모드의 변경 로그는 삽입 전용 변경 사항으로만 구성됩니다. 더 많은 통찰을 위해 아래 전용 일괄 처리 모드 섹션도 참조하십시오.</p>
<h3 id="Dependencies-and-Imports"><a href="#Dependencies-and-Imports" class="headerlink" title="Dependencies and Imports"></a>Dependencies and Imports</h3><p>Projects that combine Table API with DataStream API need to add one of the following bridging modules. They include transitive dependencies to <code>flink-table-api-java</code> or <code>flink-table-api-scala</code> and the corresponding language-specific DataStream API module.</p>
<p>Table API와 DataStream API를 결합하는 프로젝트는 다음 중 하나의 브릿징 모듈을 추가해야 합니다. 이러한 모듈은 <code>flink-table-api-java</code> 또는 <code>flink-table-api-scala</code> 및 해당 언어별 DataStream API 모듈에 대한 전이적 종속성을 포함합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>flink<span class="token operator">-</span>table<span class="token operator">-</span>api<span class="token operator">-</span>java<span class="token operator">-</span>bridge_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">1.19</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">></span></span>provided<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The following imports are required to declare common pipelines using either the Java or Scala version of both DataStream API and Table API.</p>
<p>공통 파이프라인을 선언하기 위해 DataStream API와 Table API의 Java 또는 Scala 버전 중 하나를 사용하려면 다음과 같은 import 문이 필요합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token comment">// imports for Java DataStream API</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">// imports for Table API with bridging to Java DataStream API</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token comment"># imports for Python DataStream API</span>
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># imports for Table API to Python DataStream API</span>
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> <span class="token operator">*</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Please refer to the <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/configuration/overview/">configuration</a> section for more information.</p>
<p>더 많은 정보를 원하신다면 <code>configuration</code> 섹션을 참조해주세요.</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>The <code>TableEnvironment</code> will adopt all configuration options from the passed <code>StreamExecutionEnvironment</code>. However, it cannot be guaranteed that further changes to the configuration of <code>StreamExecutionEnvironment</code> are propagated to the <code>StreamTableEnvironment</code> after its instantiation. The propagation of options from Table API to DataStream API happens during planning.</p>
<p>We recommend setting all configuration options in DataStream API early before switching to Table API.</p>
<p><code>TableEnvironment</code>은 전달된 <code>StreamExecutionEnvironment</code>의 모든 구성 옵션을 채택할 것입니다. 그러나 <code>StreamExecutionEnvironment</code>의 구성 변경이 StreamTableEnvironment에 인스턴스화된 후에도 전파되는 것을 보장할 수는 없습니다. Table API에서 DataStream API로 옵션을 전파하는 것은 계획 중에 발생합니다.</p>
<p>우리는 Table API로 전환하기 전에 DataStream API에서 모든 구성 옵션을 초기에 설정하는 것을 권장합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">ZoneId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CheckpointingMode</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span></span><span class="token punctuation">;</span>

<span class="token comment">// create Java DataStream API</span>

<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set various configuration early</span>

env<span class="token punctuation">.</span><span class="token function">setMaxParallelism</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDefaultKryoSerializer</span><span class="token punctuation">(</span><span class="token class-name">MyCustomType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CustomKryoSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">.</span><span class="token constant">EXACTLY_ONCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// then switch to Java Table API</span>

<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set configuration early</span>

tableEnv<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLocalTimeZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Europe/Berlin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// start defining your pipelines in both APIs...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> StreamTableEnvironment
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>checkpointing_mode <span class="token keyword">import</span> CheckpointingMode


<span class="token comment"># create Python DataStream API</span>
env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># set various configuration early</span>
env<span class="token punctuation">.</span>set_max_parallelism<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>

env<span class="token punctuation">.</span>get_config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_default_kryo_serializer<span class="token punctuation">(</span><span class="token string">"type_class_name"</span><span class="token punctuation">,</span> <span class="token string">"serializer_class_name"</span><span class="token punctuation">)</span>

env<span class="token punctuation">.</span>get_checkpoint_config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_checkpointing_mode<span class="token punctuation">(</span>CheckpointingMode<span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span>

<span class="token comment"># then switch to Python Table API</span>
t_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

<span class="token comment"># set configuration early</span>
t_env<span class="token punctuation">.</span>get_config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>set_local_timezone<span class="token punctuation">(</span><span class="token string">"Europe/Berlin"</span><span class="token punctuation">)</span>

<span class="token comment"># start defining your pipelines in both APIs...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Execution-Behavior"><a href="#Execution-Behavior" class="headerlink" title="Execution Behavior"></a>Execution Behavior</h3><p>Both APIs provide methods to execute pipelines. In other words: if requested, they compile a job graph that will be submitted to the cluster and triggered for execution. Results will be streamed to the declared sinks.</p>
<p>Usually, both APIs mark such behavior with the term execute in method names. However, the execution behavior is slightly different between Table API and DataStream API.</p>
<p>두 API 모두 파이프라인을 실행하기 위한 메서드를 제공합니다. 다시 말해, 요청이 있을 경우, 클러스터에 제출되고 실행을 위해 트리거될 작업 그래프를 컴파일합니다. 결과는 선언된 싱크로 스트리밍됩니다.</p>
<p>일반적으로 두 API 모두 이러한 동작을 메서드 이름에 execute라는 용어로 표시합니다. 그러나 Table API와 DataStream API 사이의 실행 동작은 약간 다릅니다.</p>
<h4 id="DataStream-API"><a href="#DataStream-API" class="headerlink" title="DataStream API"></a>DataStream API</h4><p>The DataStream API’s <code>StreamExecutionEnvironment</code> uses a <em>builder pattern</em> to construct a complex pipeline. The pipeline possibly splits into multiple branches that might or might not end with a sink. The environment buffers all these defined branches until it comes to job submission.</p>
<p><code>StreamExecutionEnvironment.execute()</code> submits the entire constructed pipeline and clears the builder afterward. In other words: no sources and sinks are declared anymore, and a new pipeline can be added to the builder. Thus, every DataStream program usually ends with a call to <code>StreamExecutionEnvironment.execute()</code>. Alternatively, <code>DataStream.executeAndCollect()</code> implicitly defines a sink for streaming the results to the local client.</p>
<p>DataStream API의 <code>StreamExecutionEnvironment</code>는 복잡한 파이프라인을 구성하기 위해 <em>빌더 패턴</em>을 사용합니다. 파이프라인은 여러 가지 분기로 나뉠 수 있으며 이들 분기 중 일부는 싱크로 끝나거나 끝나지 않을 수 있습니다. 환경은 모든 정의된 분기를 작업 제출 시까지 버퍼링합니다.</p>
<p><code>StreamExecutionEnvironment.execute()</code>는 전체 구성된 파이프라인을 제출하고 이후에 빌더를 지웁니다. 다시 말해, 더 이상 소스와 싱크가 선언되지 않으며 새로운 파이프라인을 빌더에 추가할 수 있습니다. 따라서 모든 DataStream 프로그램은 일반적으로 <code>StreamExecutionEnvironment.execute()</code>를 호출하여 끝납니다. 또는 <code>DataStream.executeAndCollect()</code>를 사용하여 결과를 로컬 클라이언트로 스트리밍하는 싱크를 암시적으로 정의할 수도 있습니다.</p>
<h4 id="Table-API"><a href="#Table-API" class="headerlink" title="Table API"></a>Table API</h4><p>In the Table API, branching pipelines are only supported within a <code>StatementSet</code> where each branch must declare a final sink. Both <code>TableEnvironment</code> and also <code>StreamTableEnvironment</code> do not offer a dedicated general <code>execute()</code> method. Instead, they offer methods for submitting a single source-to-sink pipeline or a statement set:</p>
<p>Table API에서는 각 분기가 최종 싱크를 선언해야 하는 <code>StatementSet</code> 내에서만 분기 파이프라인을 지원합니다. <code>TableEnvironment</code> 및 <code>StreamTableEnvironment</code>은 전용 일반 <code>execute()</code> 메서드를 제공하지 않습니다. 대신, 단일 소스에서 싱크로 파이프라인 또는 statement set을 제출하기 위한 메서드를 제공합니다:</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token comment">// execute with explicit sink</span>
tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"OutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO OutputTable SELECT * FROM InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createStatementSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"OutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"OutputTable2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createStatementSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addInsertSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO OutputTable SELECT * FROM InputTable"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addInsertSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO OutputTable2 SELECT * FROM InputTable"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// execute with implicit local sink</span>

tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token comment"># execute with explicit sink</span>
table_env<span class="token punctuation">.</span>from_path<span class="token punctuation">(</span><span class="token string">"input_table"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execute_insert<span class="token punctuation">(</span><span class="token string">"output_table"</span><span class="token punctuation">)</span>

table_env<span class="token punctuation">.</span>execute_sql<span class="token punctuation">(</span><span class="token string">"INSERT INTO output_table SELECT * FROM input_table"</span><span class="token punctuation">)</span>

table_env<span class="token punctuation">.</span>create_statement_set<span class="token punctuation">(</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>add_insert<span class="token punctuation">(</span><span class="token string">"output_table"</span><span class="token punctuation">,</span> input_table<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>add_insert<span class="token punctuation">(</span><span class="token string">"output_table2"</span><span class="token punctuation">,</span> input_table<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

table_env<span class="token punctuation">.</span>create_statement_set<span class="token punctuation">(</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>add_insert_sql<span class="token punctuation">(</span><span class="token string">"INSERT INTO output_table SELECT * FROM input_table"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>add_insert_sql<span class="token punctuation">(</span><span class="token string">"INSERT INTO output_table2 SELECT * FROM input_table"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># execute with implicit local sink</span>
table_env<span class="token punctuation">.</span>from_path<span class="token punctuation">(</span><span class="token string">"input_table"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

table_env<span class="token punctuation">.</span>execute_sql<span class="token punctuation">(</span><span class="token string">"SELECT * FROM input_table"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>To combine both execution behaviors, every call to <code>StreamTableEnvironment.toDataStream</code> or <code>StreamTableEnvironment.toChangelogStream</code> will materialize (i.e. compile) the Table API sub-pipeline and insert it into the DataStream API pipeline builder. This means that <code>StreamExecutionEnvironment.execute()</code> or <code>DataStream.executeAndCollect</code> must be called afterwards. An execution in Table API will not trigger these “external parts”.</p>
<p>두 실행 동작을 결합하려면 <code>StreamTableEnvironment.toDataStream</code> 또는 <code>StreamTableEnvironment.toChangelogStream</code>을 호출할 때마다 Table API 하위 파이프라인을 구체화(즉, 컴파일)하고 이를 DataStream API 파이프라인 빌더에 삽입합니다. 이는 <code>StreamExecutionEnvironment.execute()</code> 또는 <code>DataStream.executeAndCollect</code>를 그 후에 호출해야 함을 의미합니다. Table API에서의 실행은 이러한 “외부 부분”을 트리거하지 않습니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token comment">// (1)</span>

<span class="token comment">// adds a branch with a printing sink to the StreamExecutionEnvironment</span>
tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// (2)</span>

<span class="token comment">// executes a Table API end-to-end pipeline as a Flink job and prints locally,</span>
<span class="token comment">// thus (1) has still not been executed</span>
table<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// executes the DataStream API pipeline with the sink defined in (1) as a</span>
<span class="token comment">// Flink job, (2) was already running before</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token comment"># (1)</span>

<span class="token comment"># adds a branch with a printing sink to the StreamExecutionEnvironment</span>
table_env<span class="token punctuation">.</span>to_data_stream<span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># (2)</span>
<span class="token comment"># executes a Table API end-to-end pipeline as a Flink job and prints locally,</span>
<span class="token comment"># thus (1) has still not been executed</span>
table<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># executes the DataStream API pipeline with the sink defined in (1) as a</span>
<span class="token comment"># Flink job, (2) was already running before</span>
env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Batch-Runtime-Mode"><a href="#Batch-Runtime-Mode" class="headerlink" title="Batch Runtime Mode"></a>Batch Runtime Mode</h2><p>The <em>batch runtime mode</em> is a specialized execution mode for <em>bounded</em> Flink programs.</p>
<p>Generally speaking, <em>boundedness</em> is a property of a data source that tells us whether all the records coming from that source are known before execution or whether new data will show up, potentially indefinitely. A job, in turn, is bounded if all its sources are bounded, and unbounded otherwise.</p>
<p><em>Streaming runtime mode</em>, on the other hand, can be used for both bounded and unbounded jobs.</p>
<p>For more information on the different execution modes, see also the corresponding <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/datastream/execution_mode/">DataStream API section</a>.</p>
<p>The Table API &amp; SQL planner provides a set of specialized optimizer rules and runtime operators for either of the two modes.</p>
<p>Currently, the runtime mode is not derived automatically from sources, thus, it must be set explicitly or will be adopted from <code>StreamExecutionEnvironment</code> when instantiating a <code>StreamTableEnvironment</code>:</p>
<p>*일괄 처리(runtime mode)*는 <em>유한한(Finite)</em> Flink 프로그램을 위한 전용 실행 모드입니다.</p>
<p>일반적으로, <em>유한성</em>은 데이터 소스의 특성으로 해당 소스에서 나오는 모든 레코드가 실행 전에 알려져 있는지 또는 새로운 데이터가 나타날 가능성이 있는지(잠재적으로 무한히)를 나타냅니다. 한편, 모든 소스가 유한하면 작업이 유한하며 그렇지 않으면 유한하지 않습니다.</p>
<p>반면에 *스트리밍(runtime mode)*은 유한 및 무한한 작업 모두에 사용할 수 있습니다.</p>
<p>다양한 실행 모드에 대한 자세한 내용은 해당 <code>DataStream API 섹션</code>도 참조하십시오.</p>
<p>Table API &amp; SQL 플래너는 두 모드 각각에 대한 전용 옵티마이저 규칙과 실행 연산자 세트를 제공합니다.</p>
<p>현재 실행 모드는 소스에서 자동으로 파생되지 않으므로 명시적으로 설정하거나 <code>StreamExecutionEnvironment</code>에서 <code>StreamTableEnvironment</code>를 인스턴스화할 때 채택되어야 합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RuntimeExecutionMode</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">EnvironmentSettings</span></span><span class="token punctuation">;</span>

<span class="token comment">// adopt mode from StreamExecutionEnvironment</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span><span class="token constant">BATCH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or</span>

<span class="token comment">// set mode explicitly for StreamTableEnvironment</span>
<span class="token comment">// it will be propagated to StreamExecutionEnvironment during planning</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token class-name">EnvironmentSettings</span><span class="token punctuation">.</span><span class="token function">inBatchMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment<span class="token punctuation">,</span> RuntimeExecutionMode
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> EnvironmentSettings<span class="token punctuation">,</span> StreamTableEnvironment

<span class="token comment"># adopt mode from StreamExecutionEnvironment</span>
env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
env<span class="token punctuation">.</span>set_runtime_mode<span class="token punctuation">(</span>RuntimeExecutionMode<span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span>
table_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

<span class="token comment"># or</span>

<span class="token comment"># set mode explicitly for StreamTableEnvironment</span>
<span class="token comment"># it will be propagated to StreamExecutionEnvironment during planning</span>
env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>
table_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">,</span> EnvironmentSettings<span class="token punctuation">.</span>in_batch_mode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>One must meet the following prerequisites before setting the runtime mode to BATCH:</p>
<ul>
<li><p>All sources must declare themselves as bounded.</p>
</li>
<li><p>Currently, table sources must emit insert-only changes.</p>
</li>
<li><p>Operators need a sufficient amount of <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/deployment/memory/mem_setup_tm/#managed-memory">off-heap memory</a> for sorting and other intermediate results.</p>
</li>
<li><p>All table operations must be available in batch mode. Currently, some of them are only available in streaming mode. Please check the corresponding Table API &amp; SQL pages.</p>
</li>
</ul>
<p>A batch execution has the following implications (among others):</p>
<ul>
<li><p>Progressive watermarks are neither generated nor used in operators. However, sources emit a maximum watermark before shutting down.</p>
</li>
<li><p>Exchanges between tasks might be blocking according to the <code>[execution.batch-shuffle-mode](https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/deployment/config/#execution-batch-shuffle-mode)</code>. This also means potentially less resource requirements compared to executing the same pipeline in streaming mode.</p>
</li>
<li><p>Checkpointing is disabled. Artificial state backends are inserted.</p>
</li>
<li><p>Table operations don’t produce incremental updates but only a complete final result which converts to an insert-only changelog stream.</p>
</li>
</ul>
<p>BATCH 실행 모드를 설정하기 전에 다음과 같은 전제 조건을 충족해야 합니다:</p>
<ul>
<li><p>모든 소스는 자신을 유한하다고 선언해야 합니다.</p>
</li>
<li><p>현재 테이블 소스는 삽입 전용 변경 사항을 내보내야 합니다.</p>
</li>
<li><p>연산자는 정렬 및 기타 중간 결과를 위한 충분한 양의 <code>off-heap 메모리</code>가 필요합니다.</p>
</li>
<li><p>모든 테이블 작업은 일괄 처리 모드에서 사용할 수 있어야 합니다. 현재 일부 작업은 스트리밍 모드에서만 사용할 수 있습니다. 관련된 Table API 및 SQL 페이지를 확인하십시오.</p>
</li>
</ul>
<p>일괄 처리 실행은 다음과 같은 영향을 미칩니다(다른 것들 중):</p>
<ul>
<li><p>진행형 워터마크는 연산자에서 생성되거나 사용되지 않습니다. 그러나 소스는 종료하기 전에 최대 워터마크를 내보냅니다.</p>
</li>
<li><p>작업 간 교환은 <code>execution.batch-shuffle-mode</code>에 따라 차단될 수 있습니다. 이는 동일한 파이프라인을 스트리밍 모드에서 실행하는 것과 비교하여 잠재적으로 더 적은 리소스 요구 사항을 의미합니다.</p>
</li>
<li><p>체크포인트가 비활성화됩니다. 인위적인 상태 백엔드가 삽입됩니다.</p>
</li>
<li><p>테이블 작업은 증분 업데이트를 생성하지 않고 완전한 최종 결과만 생성합니다. 이 결과는 삽입 전용 변경 로그 스트림으로 변환됩니다.</p>
</li>
</ul>
<blockquote>
<p>Since batch processing can be considered as <em>a special case of stream processing</em>, we recommend implementing a streaming pipeline first as it is the most general implementation for both bounded and unbounded data.</p>
</blockquote>
<blockquote>
<p>In theory, a streaming pipeline can execute all operators. However, in practice, some operations might not make much sense as they would lead to ever-growing state and are therefore not supported. A global sort would be an example that is only available in batch mode. Simply put: it should be possible to run a working streaming pipeline in batch mode but not necessarily vice versa.</p>
</blockquote>
<p>The following example shows how to play around with batch mode using the <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/connectors/table/datagen/">DataGen table source</a>. Many sources offer options that implicitly make the connector bounded, for example, by defining a terminating offset or timestamp. In our example, we limit the number of rows with the <code>number-of-rows</code> option.</p>
<blockquote>
<p>일괄 처리는 <em>스트림 처리의 특수한 경우</em>로 간주될 수 있으므로, 유한 및 무한 데이터에 대해 가장 일반적인 구현인 스트리밍 파이프라인을 먼저 구현하는 것이 좋습니다.</p>
</blockquote>
<blockquote>
<p>이론적으로 스트리밍 파이프라인은 모든 연산자를 실행할 수 있습니다. 그러나 실제로는 일부 작업이 계속 커지는 상태로 이어지므로 이러한 작업은 지원되지 않을 수 있습니다. 전역 정렬은 일괄 처리 모드에서만 사용할 수 있는 예입니다. 간단히 말해, 스트리밍 파이프라인은 일괄 처리 모드에서 작동하는 것이 가능하지만 그 반대는 꼭 그렇지 않을 수 있습니다.</p>
</blockquote>
<p>다음 예는 DataGen 테이블 소스를 사용하여 배치 모드를 다루는 방법을 보여줍니다. 많은 소스는 종료 오프셋이나 타임스탬프를 정의함으로써 커넥터를 암시적으로 유한하게 만드는 옵션을 제공합니다. 우리의 예에서는 <code>number-of-rows</code> 옵션을 사용하여 행의 수를 제한합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TableDescriptor</span></span><span class="token punctuation">;</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
        <span class="token class-name">TableDescriptor</span><span class="token punctuation">.</span><span class="token function">forConnector</span><span class="token punctuation">(</span><span class="token string">"datagen"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"number-of-rows"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token comment">// make the source bounded</span>
            <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span>
                <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TINYINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// convert the Table to a DataStream and further transform the pipeline</span>
tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Byte</span><span class="token punctuation">></span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">-></span> <span class="token string">"My custom operator: "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">executeAndCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// My custom operator: 9660912d30a43c7b035e15bd...</span>
<span class="token comment">// My custom operator: 29f5f706d2144f4a4f9f52a0...</span>
<span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><div class="caption"><span>python</span></div><code class="language-python"><span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> TableDescriptor<span class="token punctuation">,</span> Schema<span class="token punctuation">,</span> DataTypes

table <span class="token operator">=</span> table_env<span class="token punctuation">.</span>from_descriptor<span class="token punctuation">(</span>
    TableDescriptor<span class="token punctuation">.</span>for_connector<span class="token punctuation">(</span><span class="token string">"datagen"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"number-of-rows"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>schema<span class="token punctuation">(</span>
        Schema<span class="token punctuation">.</span>new_builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>column<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>TINYINT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>column<span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># convert the Table to a DataStream and further transform the pipeline</span>
collect <span class="token operator">=</span> table_env<span class="token punctuation">.</span>to_data_stream<span class="token punctuation">(</span>table<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>key_by<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> <span class="token string">"My custom operator: "</span> <span class="token operator">+</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>execute_and_collect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> c <span class="token keyword">in</span> collect<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

<span class="token comment"># prints:</span>
<span class="token comment"># My custom operator: 9660912d30a43c7b035e15bd...</span>
<span class="token comment"># My custom operator: 29f5f706d2144f4a4f9f52a0...</span>
<span class="token comment"># ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Changelog-Unification"><a href="#Changelog-Unification" class="headerlink" title="Changelog Unification"></a>Changelog Unification</h3><p>In most cases, the pipeline definition itself can remain constant in both Table API and DataStream API when switching from streaming to batch mode and vice versa. However, as mentioned before, the resulting changelog streams might differ due to the avoidance of incremental operations in batch mode.</p>
<p>Time-based operations that rely on event-time and leverage watermarks as a completeness marker are able to produce an insert-only changelog stream that is independent of the runtime mode.</p>
<p>The following Java example illustrates a Flink program that is not only unified on an API level but also in the resulting changelog stream. The example joins two tables in SQL (<code>UserTable</code> and <code>OrderTable</code>) using an interval join based on the time attributes in both tables (<code>ts</code>). It uses DataStream API to implement a custom operator that deduplicates the user name using a <code>KeyedProcessFunction</code> and value state.</p>
<p>대부분의 경우에는 스트리밍 모드에서 배치 모드로 전환하거나 그 반대로 전환할 때 파이프라인 정의 자체는 Table API 및 DataStream API에서 동일할 수 있습니다. 그러나 앞에서 언급한 바와 같이 배치 모드에서는 증분적인 작업을 피하기 때문에 결과적인 변경 로그 스트림이 다를 수 있습니다.</p>
<p>이벤트 시간에 의존하고 워터마크를 사용하여 완료 마커로 작동하는 시간 기반 작업은 런타임 모드와 독립적인 삽입 전용 변경 로그 스트림을 생성할 수 있습니다.</p>
<p>다음의 Java 예제는 Flink 프로그램을 보여줍니다. 이 예제는 API 수준뿐만 아니라 결과적인 변경 로그 스트림에서도 통일되어 있습니다. 이 예제는 두 개의 테이블(<code>UserTable</code>과 <code>OrderTable</code>)을 SQL에서 (<code>ts</code>를 기반으로 한 인터벌 조인을 사용하여) 조인합니다. 또한 <code>KeyedProcessFunction</code>과 값을 상태로 사용하여 사용자 이름을 중복 제거하는 사용자 정의 연산자를 DataStream API를 사용하여 구현합니다.</p>
<pre class="line-numbers language-java" data-language="java"><div class="caption"><span>java</span></div><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RuntimeExecutionMode</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span></span><span class="token class-name">Types</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token comment">// setup DataStream API</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// use BATCH or STREAMING mode</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span><span class="token constant">BATCH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// setup Table API</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create a user stream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> userStream <span class="token operator">=</span> env
    <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:00:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:05:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:10:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>
        <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">ROW_NAMED</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">LOCAL_DATE_TIME</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create an order stream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> orderStream <span class="token operator">=</span> env
    <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:02:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:07:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">239</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:11:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>
        <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">ROW_NAMED</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"amount"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">LOCAL_DATE_TIME</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token constant">INT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create corresponding tables</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span>
    <span class="token string">"UserTable"</span><span class="token punctuation">,</span>
    userStream<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"ts - INTERVAL '1' SECOND"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span>
    <span class="token string">"OrderTable"</span><span class="token punctuation">,</span>
    orderStream<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"ts - INTERVAL '1' SECOND"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// perform interval join</span>
<span class="token class-name">Table</span> joinedTable <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
        <span class="token string">"SELECT U.name, O.amount "</span> <span class="token operator">+</span>
        <span class="token string">"FROM UserTable U, OrderTable O "</span> <span class="token operator">+</span>
        <span class="token string">"WHERE U.uid = O.uid AND O.ts BETWEEN U.ts AND U.ts + INTERVAL '5' MINUTES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">></span></span> joinedStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>joinedTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

joinedStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// implement a custom operator using ProcessFunction and value state</span>
joinedStream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

          <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> seen<span class="token punctuation">;</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">OpenContext</span> openContext<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              seen <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"seen"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Row</span> row<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> out<span class="token punctuation">)</span>
                  <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
              <span class="token class-name">String</span> name <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  seen<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// execute unified pipeline</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints (in both BATCH and STREAMING mode):</span>
<span class="token comment">// +I[Bob, 239]</span>
<span class="token comment">// +I[Alice, 122]</span>
<span class="token comment">// +I[Bob, 999]</span>
<span class="token comment">//</span>
<span class="token comment">// Bob</span>
<span class="token comment">// Alice</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>common <span class="token keyword">import</span> Row<span class="token punctuation">,</span> Types
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream <span class="token keyword">import</span> StreamExecutionEnvironment<span class="token punctuation">,</span> RuntimeExecutionMode<span class="token punctuation">,</span>
    KeyedProcessFunction<span class="token punctuation">,</span> RuntimeContext
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>state <span class="token keyword">import</span> ValueStateDescriptor
<span class="token keyword">from</span> pyflink<span class="token punctuation">.</span>table <span class="token keyword">import</span> StreamTableEnvironment<span class="token punctuation">,</span> Schema<span class="token punctuation">,</span> DataTypes

<span class="token comment"># setup DataStream API</span>
env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>get_execution_environment<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># use BATCH or STREAMING mode</span>
env<span class="token punctuation">.</span>set_runtime_mode<span class="token punctuation">(</span>RuntimeExecutionMode<span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span>

<span class="token comment"># setup Table API</span>
table_env <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

<span class="token comment"># create a user stream</span>
t_format <span class="token operator">=</span> <span class="token string">"%Y-%m-%dT%H:%M:%S"</span>
user_stream <span class="token operator">=</span> env<span class="token punctuation">.</span>from_collection<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>Row<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span><span class="token string">"2021-08-21T13:00:00"</span><span class="token punctuation">,</span> t_format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     Row<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span><span class="token string">"2021-08-21T13:05:00"</span><span class="token punctuation">,</span> t_format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     Row<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span><span class="token string">"2021-08-21T13:10:00"</span><span class="token punctuation">,</span> t_format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    type_info<span class="token operator">=</span>Types<span class="token punctuation">.</span>ROW_NAMED<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"ts1"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              <span class="token punctuation">[</span>Types<span class="token punctuation">.</span>SQL_TIMESTAMP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># create an order stream</span>
order_stream <span class="token operator">=</span> env<span class="token punctuation">.</span>from_collection<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>Row<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span><span class="token string">"2021-08-21T13:02:00"</span><span class="token punctuation">,</span> t_format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     Row<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span><span class="token string">"2021-08-21T13:07:00"</span><span class="token punctuation">,</span> t_format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">239</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     Row<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span><span class="token string">"2021-08-21T13:11:00"</span><span class="token punctuation">,</span> t_format<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    type_info<span class="token operator">=</span>Types<span class="token punctuation">.</span>ROW_NAMED<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"ts1"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"amount"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token punctuation">[</span>Types<span class="token punctuation">.</span>SQL_TIMESTAMP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># # create corresponding tables</span>
table_env<span class="token punctuation">.</span>create_temporary_view<span class="token punctuation">(</span>
    <span class="token string">"user_table"</span><span class="token punctuation">,</span>
    user_stream<span class="token punctuation">,</span>
    Schema<span class="token punctuation">.</span>new_builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>column_by_expression<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"CAST(ts1 AS TIMESTAMP(3))"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>column<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>column<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>watermark<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"ts - INTERVAL '1' SECOND"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

table_env<span class="token punctuation">.</span>create_temporary_view<span class="token punctuation">(</span>
    <span class="token string">"order_table"</span><span class="token punctuation">,</span>
    order_stream<span class="token punctuation">,</span>
    Schema<span class="token punctuation">.</span>new_builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>column_by_expression<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"CAST(ts1 AS TIMESTAMP(3))"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>column<span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>column<span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>INT<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>watermark<span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"ts - INTERVAL '1' SECOND"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># perform interval join</span>
joined_table <span class="token operator">=</span> table_env<span class="token punctuation">.</span>sql_query<span class="token punctuation">(</span>
    <span class="token string">"SELECT U.name, O.amount "</span> <span class="token operator">+</span>
    <span class="token string">"FROM user_table U, order_table O "</span> <span class="token operator">+</span>
    <span class="token string">"WHERE U.uid = O.uid AND O.ts BETWEEN U.ts AND U.ts + INTERVAL '5' MINUTES"</span><span class="token punctuation">)</span>

joined_stream <span class="token operator">=</span> table_env<span class="token punctuation">.</span>to_data_stream<span class="token punctuation">(</span>joined_table<span class="token punctuation">)</span>

joined_stream<span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># implement a custom operator using ProcessFunction and value state</span>
<span class="token keyword">class</span> <span class="token class-name">MyProcessFunction</span><span class="token punctuation">(</span>KeyedProcessFunction<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>seen <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">open</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> runtime_context<span class="token punctuation">:</span> RuntimeContext<span class="token punctuation">)</span><span class="token punctuation">:</span>
        state_descriptor <span class="token operator">=</span> ValueStateDescriptor<span class="token punctuation">(</span><span class="token string">"seen"</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>STRING<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>seen <span class="token operator">=</span> runtime_context<span class="token punctuation">.</span>get_state<span class="token punctuation">(</span>state_descriptor<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_element</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        name <span class="token operator">=</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>seen<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>seen<span class="token punctuation">.</span>update<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> name

joined_stream \
    <span class="token punctuation">.</span>key_by<span class="token punctuation">(</span><span class="token keyword">lambda</span> r<span class="token punctuation">:</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>process<span class="token punctuation">(</span>MyProcessFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># execute unified pipeline</span>
env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># prints (in both BATCH and STREAMING mode):</span>
<span class="token comment"># +I[Bob, 239]</span>
<span class="token comment"># +I[Alice, 122]</span>
<span class="token comment"># +I[Bob, 999]</span>
<span class="token comment">#</span>
<span class="token comment"># Bob</span>
<span class="token comment"># Alice</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Handling-of-Insert-Only-Stream"><a href="#Handling-of-Insert-Only-Stream" class="headerlink" title="Handling of (Insert-Only) Stream"></a>Handling of (Insert-Only) Stream</h2><p>A StreamTableEnvironment offers the following methods to convert from and to DataStream API:</p>
<ul>
<li><p><code>fromDataStream(DataStream)</code>: Interprets a stream of insert-only changes and arbitrary type as a table. Event-time and watermarks are not propagated by default.</p>
</li>
<li><p><code>fromDataStream(DataStream, Schema)</code>: Interprets a stream of insert-only changes and arbitrary type as a table. The optional schema allows to enrich column data types and add time attributes, watermarks strategies, other computed columns, or primary keys.</p>
</li>
<li><p><code>createTemporaryView(String, DataStream)</code>: Registers the stream under a name to access it in SQL. It is a shortcut for <code>createTemporaryView(String, fromDataStream(DataStream))</code>.</p>
</li>
<li><p><code>createTemporaryView(String, DataStream, Schema)</code>: Registers the stream under a name to access it in SQL. It is a shortcut for <code>createTemporaryView(String, fromDataStream(DataStream, Schema))</code>.</p>
</li>
<li><p><code>toDataStream(Table)</code>: Converts a table into a stream of insert-only changes. The default stream record type is <code>org.apache.flink.types.Row</code>. A single rowtime attribute column is written back into the DataStream API’s record. Watermarks are propagated as well.</p>
</li>
<li><p><code>toDataStream(Table, AbstractDataType)</code>: Converts a table into a stream of insert-only changes. This method accepts a data type to express the desired stream record type. The planner might insert implicit casts and reorders columns to map columns to fields of the (possibly nested) data type.</p>
</li>
<li><p><code>toDataStream(Table, Class)</code>: A shortcut for <code>toDataStream(Table, DataTypes.of(Class))</code> to quickly create the desired data type reflectively.</p>
</li>
</ul>
<p>From a Table API’s perspective, converting from and to DataStream API is similar to reading from or writing to a virtual table connector that has been defined using a <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/sql/create/#create-table">CREATE TABLE DDL</a> in SQL.</p>
<p>The schema part in the virtual <code>CREATE TABLE name (schema) WITH (options)</code> statement can be automatically derived from the DataStream’s type information, enriched, or entirely defined manually using <code>org.apache.flink.table.api.Schema</code>.</p>
<p>The virtual DataStream table connector exposes the following metadata for every row:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Data Type</th>
<th>Description</th>
<th>R&#x2F;W</th>
</tr>
</thead>
<tbody><tr>
<td>rowtime</td>
<td>TIMESTAMP_LTZ(3) NOT NULL</td>
<td>Stream record’s timestamp.</td>
<td>R&#x2F;W</td>
</tr>
</tbody></table>
<p>The virtual DataStream table source implements <a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/sourcessinks/#source-abilities">SupportsSourceWatermark</a> and thus allows calling the SOURCE_WATERMARK() built-in function as a watermark strategy to adopt watermarks from the DataStream API.</p>
<p>스트림 테이블 환경(StreamTableEnvironment)은 다음과 같은 메서드를 제공하여 DataStream API로 변환하거나 DataStream API에서 변환할 수 있습니다:</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/data_stream_api/">https://nightlies.apache.org/flink/flink-docs-release-1.19/docs/dev/table/data_stream_api/</a></li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        Author:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Keyhong</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        Link:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2024/03/23/Flink/Application%20Development/Table%20API%20&%20SQL/DataStream%20API%20Integration/">http://example.com/2024/03/23/Flink/Application%20Development/Table%20API%20&%20SQL/DataStream%20API%20Integration/</a>
                </span>
            </div>
            <!-- <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        reprint:
                    </i>
                </span>
                <span class="reprint-info">
                    use
                    <a href="cc_by_url" rel="external nofollow noreferrer" target="_blank">cc_by_name</a>
                    licensed
                    <a href="/about" target="_blank">Keyhong</a>
                    !
                </span>
            </div> -->
        
    </div>

    <!-- <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>Copied successfully, please follow the reprint policy of this article</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">more</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script> -->



            <div class="tag_share" style="display: block;">
                <!-- <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">No tag</span>
                        </div>
                    
                </div> -->
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <!-- <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a> -->

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>댓글</span>
    </div>
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="/libs/gitment/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Sat Mar 23 2024 00:00:00 GMT+0900',
    owner: '',
    repo: '',
    oauth: {
        client_id: '',
        client_secret: ''
    }
});

gitment.render('gitment-content');
</script>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2024/03/23/Flink/Application%20Development/Table%20API%20&%20SQL/Concepts%20&%20Common%20API/">
                    <div class="card-image">
                        
                        <img src="/images/logos/flink-logo.png" class="responsive-img" alt="[Flink] Table API &amp; SQL - Concepts &amp; Common API">
                        
                        <span class="card-title diy-neon-red">[Flink] Table API &amp; SQL - Concepts &amp; Common API</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-03-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Flink/" class="post-category">
                                    Flink
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/03/18/MongoDB/PyMongo/MongoDB%20Document/">
                    <div class="card-image">
                        
                        <img src="/images/logos/mongodb-logo.png" class="responsive-img" alt="[PyMongo] Documents">
                        
                        <span class="card-title diy-neon-red">[PyMongo] Documents</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-03-18
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MongoDB/" class="post-category">
                                    MongoDB
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;목차</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <a href="/about" target="_blank">Gyuwon Hong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/keyhong" class="tooltipped" target="_blank" data-tooltip="GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wnhong96@gmail.com" class="tooltipped" target="_blank" data-tooltip="Email" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
